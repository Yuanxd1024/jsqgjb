name: 嘉立创全自动并发抢购

on:
  workflow_dispatch:  # 允许手动触发
  schedule:
    # 每天 UTC 22点 (北京时间 6:00) 运行
    - cron: '00 22 * * *'

jobs:
  # 第一阶段：解析配置并注入序号
  prepare-matrix:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
    steps:
      - name: 检出代码
        uses: actions/checkout@v3

      - name: 读取配置生成带序号的矩阵
        id: set-matrix
        run: |
          # 使用 Python 处理 json，为每个对象添加 index 字段（自动补零，例如 01, 02）
          # 这样可以确保 Job 名字在 UI 上按顺序排列
          python3 -c '
          import json
          import os

          try:
              with open("./config.json", "r", encoding="utf-8") as f:
                  data = json.load(f)
              
              # 遍历并添加序号
              for i, item in enumerate(data):
                  # 格式化为 01, 02... 适合最多99个账号，如果更多请改为 {:03d}
                  item["index"] = "{:02d}".format(i + 1)
              
              # 输出压缩后的 JSON
              json_str = json.dumps(data)
              # 写入 GitHub Output
              with open(os.environ["GITHUB_OUTPUT"], "a") as env_file:
                  env_file.write(f"matrix={json_str}")
                  
          except Exception as e:
              print(f"Error processing config: {e}")
              exit(1)
          '

  # 第二阶段：并发执行 (根据账号数量自动并行)
  seckill-attack:
    needs: prepare-matrix
    runs-on: ubuntu-22.04
    strategy:
      fail-fast: false # 关键：一个账号失败不影响其他账号
      max-parallel: 20 # GitHub 免费版限制并发数，防止排队过长
      matrix:
        account: ${{ fromJson(needs.prepare-matrix.outputs.matrix) }}
    
    # 修改此处：在名字前加上序号，强制 GitHub UI 按此排序
    name: ${{ matrix.account.index }}-抢购-${{ matrix.account.username }}
    
    steps:
      - name: '检出代码'
        uses: actions/checkout@v3
        
      - name: '设置Python环境'
        uses: actions/setup-python@v5
        with:
          python-version: 3.9
          
      - name: '设置时区'
        run: sudo timedatectl set-timezone Asia/Shanghai
          
      - name: '安装依赖'
        run: |
          pip install --upgrade pip
          pip install pytz
          pip install requests==2.26.0
          pip install lxml==4.6.5
          pip install selenium==3.141.0
          pip install numpy==1.19.5
          pip install retrying==1.3.3
          pip install wheel==0.37.1
          
      - name: '准备Chrome驱动'
        uses: nanasess/setup-chromedriver@v2
        
      - name: '执行抢购'
        env:
          USER: ${{ matrix.account.username }}
          PASSWORD: ${{ matrix.account.password }}
          SKU: ${{ matrix.account.sku }}
          ACT_ID: ${{ matrix.account.activity_id }}
        run: |
          echo "正在启动任务 [${{ matrix.account.index }}]：用户 $USER 目标 $SKU"
          # 将参数传递给 Python 脚本
          python ./jlc.py "$USER" "$PASSWORD" "$SKU" "$ACT_ID"
